# 手机维修系统 - 技术实现指南

**作者：** MiniMax Agent  
**日期：** 2025-07-17

## 项目初始化步骤

### 1. 创建 Next.js 项目
```bash
npx create-next-app@latest repair-shop-system --typescript --tailwind --eslint --app
cd repair-shop-system
```

### 2. 安装核心依赖
```bash
# 数据库和ORM
npm install prisma @prisma/client

# 认证
npm install next-auth

# UI组件
npm install @radix-ui/react-* lucide-react

# 状态管理
npm install zustand

# 表单处理
npm install react-hook-form @hookform/resolvers zod

# 日期处理
npm install date-fns

# 图片上传
npm install @vercel/blob
```

## 核心技术实现

### 1. Prisma 数据库配置

#### prisma/schema.prisma
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(TECHNICIAN)
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联
  orders    Order[]  @relation("TechnicianOrders")
  repairLogs RepairLog[]
  
  @@map("users")
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String   @unique
  email     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联
  orders    Order[]
  
  @@map("customers")
}

model Order {
  id               String       @id @default(cuid())
  orderNumber      String       @unique
  customerId       String
  deviceModel      String
  issueDescription String
  status           OrderStatus  @default(PENDING)
  estimatedCost    Decimal?
  finalCost        Decimal?
  technicianId     String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  // 关联
  customer         Customer     @relation(fields: [customerId], references: [id])
  technician       User?        @relation("TechnicianOrders", fields: [technicianId], references: [id])
  statusHistory    OrderStatusHistory[]
  repairLogs       RepairLog[]
  
  @@map("orders")
}

model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  status    OrderStatus
  notes     String?
  createdBy String
  createdAt DateTime @default(now())
  
  // 关联
  order     Order    @relation(fields: [orderId], references: [id])
  
  @@map("order_status_history")
}

model RepairLog {
  id           String   @id @default(cuid())
  orderId      String
  technicianId String
  action       String
  notes        String?
  images       String[] // JSON array of image URLs
  createdAt    DateTime @default(now())
  
  // 关联
  order        Order    @relation(fields: [orderId], references: [id])
  technician   User     @relation(fields: [technicianId], references: [id])
  
  @@map("repair_logs")
}

enum Role {
  ADMIN
  TECHNICIAN
  MANAGER
}

enum OrderStatus {
  PENDING
  DIAGNOSED
  QUOTED
  APPROVED
  IN_PROGRESS
  TESTING
  COMPLETED
  DELIVERED
  CANCELLED
}
```

### 2. API 路由示例

#### app/api/orders/route.ts
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const status = searchParams.get('status');
    const technicianId = searchParams.get('technicianId');

    const orders = await prisma.order.findMany({
      where: {
        ...(status && { status }),
        ...(technicianId && { technicianId }),
      },
      include: {
        customer: true,
        technician: true,
        statusHistory: {
          orderBy: { createdAt: 'desc' },
          take: 1,
        },
      },
      orderBy: { createdAt: 'desc' },
    });

    return NextResponse.json(orders);
  } catch (error) {
    console.error('获取订单失败:', error);
    return NextResponse.json(
      { error: '服务器错误' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json({ error: '未授权' }, { status: 401 });
    }

    const body = await request.json();
    const { customerId, deviceModel, issueDescription } = body;

    // 生成订单号
    const orderNumber = `WX${Date.now().toString().slice(-8)}`;

    const order = await prisma.order.create({
      data: {
        orderNumber,
        customerId,
        deviceModel,
        issueDescription,
        status: 'PENDING',
      },
      include: {
        customer: true,
      },
    });

    // 记录状态历史
    await prisma.orderStatusHistory.create({
      data: {
        orderId: order.id,
        status: 'PENDING',
        notes: '订单已创建',
        createdBy: session.user.id,
      },
    });

    return NextResponse.json(order, { status: 201 });
  } catch (error) {
    console.error('创建订单失败:', error);
    return NextResponse.json(
      { error: '服务器错误' },
      { status: 500 }
    );
  }
}
```

### 3. 组件设计示例

#### components/order/OrderCard.tsx
```typescript
'use client';

import { Order, Customer, User, OrderStatus } from '@prisma/client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { formatDate } from '@/lib/utils';

interface OrderWithRelations extends Order {
  customer: Customer;
  technician?: User;
}

interface OrderCardProps {
  order: OrderWithRelations;
  onStatusUpdate?: (orderId: string, status: OrderStatus) => void;
}

const statusColors = {
  PENDING: 'bg-yellow-100 text-yellow-800',
  DIAGNOSED: 'bg-blue-100 text-blue-800',
  QUOTED: 'bg-purple-100 text-purple-800',
  APPROVED: 'bg-green-100 text-green-800',
  IN_PROGRESS: 'bg-orange-100 text-orange-800',
  TESTING: 'bg-indigo-100 text-indigo-800',
  COMPLETED: 'bg-green-100 text-green-800',
  DELIVERED: 'bg-gray-100 text-gray-800',
  CANCELLED: 'bg-red-100 text-red-800',
};

const statusLabels = {
  PENDING: '待处理',
  DIAGNOSED: '已诊断',
  QUOTED: '已报价',
  APPROVED: '已确认',
  IN_PROGRESS: '维修中',
  TESTING: '测试中',
  COMPLETED: '已完成',
  DELIVERED: '已交付',
  CANCELLED: '已取消',
};

export function OrderCard({ order, onStatusUpdate }: OrderCardProps) {
  return (
    <Card className="hover:shadow-lg transition-shadow">
      <CardHeader>
        <div className="flex justify-between items-start">
          <CardTitle className="text-lg font-semibold">
            {order.orderNumber}
          </CardTitle>
          <Badge className={statusColors[order.status]}>
            {statusLabels[order.status]}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          <div>
            <span className="font-medium">客户：</span>
            {order.customer.name}
          </div>
          <div>
            <span className="font-medium">设备：</span>
            {order.deviceModel}
          </div>
          <div>
            <span className="font-medium">问题：</span>
            <p className="text-sm text-gray-600 mt-1">
              {order.issueDescription}
            </p>
          </div>
          {order.technician && (
            <div>
              <span className="font-medium">技术员：</span>
              {order.technician.name}
            </div>
          )}
          {order.estimatedCost && (
            <div>
              <span className="font-medium">预估费用：</span>
              ¥{order.estimatedCost.toString()}
            </div>
          )}
          <div className="text-sm text-gray-500">
            创建时间：{formatDate(order.createdAt)}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### 4. 移动端优化实现

#### components/mobile/MobileOrderList.tsx
```typescript
'use client';

import { useState, useEffect } from 'react';
import { Order } from '@prisma/client';
import { PullToRefresh } from '@/components/ui/pull-to-refresh';
import { VirtualizedList } from '@/components/ui/virtualized-list';
import { MobileOrderCard } from './MobileOrderCard';

export function MobileOrderList() {
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  const fetchOrders = async () => {
    try {
      const response = await fetch('/api/orders');
      const data = await response.json();
      setOrders(data);
    } catch (error) {
      console.error('获取订单失败:', error);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchOrders();
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  if (loading) {
    return <div className="p-4">加载中...</div>;
  }

  return (
    <PullToRefresh onRefresh={handleRefresh} refreshing={refreshing}>
      <VirtualizedList
        items={orders}
        renderItem={(order, index) => (
          <MobileOrderCard key={order.id} order={order} />
        )}
        itemHeight={120}
        className="h-screen"
      />
    </PullToRefresh>
  );
}
```

### 5. PWA 配置

#### public/manifest.json
```json
{
  "name": "手机维修管理系统",
  "short_name": "维修系统",
  "description": "专业的手机维修订单管理系统",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "orientation": "portrait-primary",
  "categories": ["business", "productivity"]
}
```

## 部署配置

### 1. Vercel 环境变量
```env
# 数据库
DATABASE_URL="postgresql://..."

# NextAuth
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="https://your-domain.com"

# 文件上传
BLOB_READ_WRITE_TOKEN="your-vercel-blob-token"

# 邮件服务（可选）
EMAIL_SERVER_HOST="smtp.gmail.com"
EMAIL_SERVER_PORT=587
EMAIL_SERVER_USER="your-email@gmail.com"
EMAIL_SERVER_PASSWORD="your-app-password"
EMAIL_FROM="your-email@gmail.com"
```

### 2. vercel.json 配置
```json
{
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "rewrites": [
    {
      "source": "/admin/:path*",
      "destination": "/admin/:path*"
    },
    {
      "source": "/technician/:path*",
      "destination": "/technician/:path*"
    }
  ]
}
```

## 性能优化建议

### 1. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_technician ON orders(technician_id);
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_created_at ON orders(created_at);
```

### 2. 缓存策略
```typescript
// lib/cache.ts
import { unstable_cache } from 'next/cache';

export const getCachedOrders = unstable_cache(
  async (status?: string) => {
    const orders = await prisma.order.findMany({
      where: status ? { status } : {},
      include: {
        customer: true,
        technician: true,
      },
    });
    return orders;
  },
  ['orders'],
  {
    revalidate: 60, // 1分钟缓存
    tags: ['orders'],
  }
);
```

### 3. 图片优化
```typescript
// components/OptimizedImage.tsx
import Image from 'next/image';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width: number;
  height: number;
}

export function OptimizedImage({ src, alt, width, height }: OptimizedImageProps) {
  return (
    <Image
      src={src}
      alt={alt}
      width={width}
      height={height}
      quality={75}
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,..."
      className="rounded-lg"
    />
  );
}
```

## 安全措施实现

### 1. API 中间件
```typescript
// middleware.ts
import { withAuth } from 'next-auth/middleware';

export default withAuth(
  function middleware(req) {
    // 权限检查逻辑
    const { pathname } = req.nextUrl;
    const { token } = req.nextauth;

    if (pathname.startsWith('/admin') && token?.role !== 'ADMIN') {
      return new Response('Forbidden', { status: 403 });
    }

    if (pathname.startsWith('/technician') && !['ADMIN', 'TECHNICIAN'].includes(token?.role)) {
      return new Response('Forbidden', { status: 403 });
    }
  },
  {
    callbacks: {
      authorized: ({ token }) => !!token,
    },
  }
);

export const config = {
  matcher: ['/admin/:path*', '/technician/:path*', '/api/protected/:path*'],
};
```

### 2. 输入验证
```typescript
// lib/validations.ts
import { z } from 'zod';

export const createOrderSchema = z.object({
  customerId: z.string().cuid(),
  deviceModel: z.string().min(1, '请输入设备型号'),
  issueDescription: z.string().min(10, '请详细描述问题，至少10个字符'),
});

export const updateOrderStatusSchema = z.object({
  status: z.enum(['PENDING', 'DIAGNOSED', 'QUOTED', 'APPROVED', 'IN_PROGRESS', 'TESTING', 'COMPLETED', 'DELIVERED', 'CANCELLED']),
  notes: z.string().optional(),
});
```

这个技术实现指南为您提供了具体的代码示例和配置方案。您可以按照这个指南逐步实现您的手机维修订单管理系统。有什么特定的技术问题需要进一步讨论吗？